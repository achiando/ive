# Project Tasks

## Completed Tasks

- Replaced `userProjects` with an action in `app/(dashboard)/equipments/[id]/view/_components/EquipmentView.tsx`.
- Implemented role-based project fetching in `lib/actions/project.ts`.
- Integrated the new project fetching action into `app/(dashboard)/equipments/[id]/view/page.tsx`.
- Updated `Project` type definition in `types/equipment.ts` for type compatibility.
- Implemented bulk equipment upload page with file parsing, server action integration, and result display.
- Implemented equipment report page with charts, statistics, and PDF export.
- Fixed type incompatibility for `initialData` in `app/(dashboard)/events/[id]/page.tsx` by explicitly picking fields and converting Date objects to strings.
- Implemented core consumables management (CRUD actions, form, add/edit page, listing page with stats, card, table columns, cell actions).
- Implemented consumable allocations management (CRUD actions, listing page with table columns, cell actions).
- Implemented consumable bulk upload (server action, bulk upload page).
- Implemented consumable analytics (server action, analytics dashboard component, analytics page).
- Updated equipment bulk upload sample CSV to include valid `EquipmentStatus` options.
- Implemented maintenance management (CRUD server actions, form, add/edit page, listing page with table, columns, cell actions, and report page).
- Fixed type incompatibility in `ConsumableWithRelations` by adjusting the `equipment` property type in `types/consumable.ts` to match the data fetched by `getAllConsumables`.
- Fixed type error in `ConsumableAllocationForm.tsx` by importing `MaintenanceWithRelations` instead of `MaintenanceDetails` from `types/maintenance.ts`.
- Fixed type incompatibility in `MaintenanceWithRelations` by adjusting `maintenanceId` to `string | null` within `consumableAllocations` in `types/maintenance.ts`.
- Fixed type error in `app/(dashboard)/dashboard/_components/Dashboard.tsx` by adding `currentUserId: string;` to `TechnicianDashboardProps` in `app/(dashboard)/dashboard/_components/TechnicianDashboard.tsx`.
- Fixed type error in `app/(dashboard)/equipments/[id]/view/page.tsx` by adding `fetchUserProjects: () => Promise<any>;` to `EquipmentViewProps` in `app/(dashboard)/equipments/[id]/view/_components/EquipmentView.tsx`.
- Fixed type error in `app/(dashboard)/equipments/report/_components/EquipmentReportClient.tsx` by correcting prop names for `DateRangePicker` from `dateRange` and `setDateRange` to `date` and `onDateChange` respectively.
- Fixed type error in `app/(dashboard)/maintenance/report/_components/MaintenanceReportClient.tsx` by correcting prop names for `DateRangePicker` from `dateRange` and `setDateRange` to `date` and `onDateChange` respectively.
- Fixed type error in `app/(dashboard)/projects/[id]/documents/_components/DocumentCard.tsx` by handling `document.fileType` being `null` when passed to the `type` prop of the `<source>` element.
- Fixed type error in `app/(dashboard)/projects/_components/columns.tsx` by modifying `getStatusVariant` to return valid `Badge` variants and applying custom styling via `className`.
- Fixed type error in `app/(dashboard)/users/_components/UserRoleStats.tsx` by adding `FACULTY` to `roleIcons` and explicitly typing `roleIcons` as `Record<UserRole, JSX.Element>`.
- **Fixed type error in `app/(dashboard)/users/_components/UsersPageClient.tsx`**: Updated `UsersPageClientProps` to use `UserWithCounts[]` for the `users` prop and added the corresponding import.
- **Fixed type error in `app/(public)/invite/[projectId]/_components/InviteClient.tsx`**: Replaced `sessionStatus === 'loading'` with `sessionLoading` in the disabled prop of the join project button.
- **Fixed type error in `lib/actions/booking.ts`**: Imported `BookingAnalyticsData` from `types/booking.ts`.
- **Fixed type error in `lib/actions/equipment.ts`**: Updated the `select` statement in `getProjectsForEquipment` to include all fields required by the `Project` type.
- **Fixed type error in `lib/email.ts`**: Removed duplicate `title` property from the `PENDING` object in `statusMap`.
- **Implemented Booking Analytics:**
    - Created `app/(dashboard)/bookings/_components/BookingAnalytics.tsx` component.
    - Added `getBookingAnalytics` server action to `lib/actions/booking.ts`.
    - Integrated analytics data fetching and rendering into `app/(dashboard)/bookings/page.tsx` and `app/(dashboard)/bookings/_components/BookingsPageClient.tsx`.
- **Implemented Consumable Allocation Management:**
    - Defined `ConsumableAllocationFormData` in `types/consumable.ts`.
    - Created `app/(dashboard)/consumables/allocations/_components/ConsumableAllocationForm.tsx` component.
    - Modified `lib/actions/consumable-allocation.ts` to handle `userId` and `allocatedBy` from session, and added authorization for `updateConsumableAllocation`.
    - Implemented `app/(dashboard)/consumables/allocations/[id]/page.tsx` to handle both creation (id='new') and editing of allocations.
    - Updated `app/(dashboard)/consumables/allocations/_components/ConsumableAllocationsPageClient.tsx` with a "New Allocation" button.
    - Updated `app/(dashboard)/consumables/allocations/_components/cell-action.tsx` with an "Edit" option.
- **Enhanced Session Management for Pending Page:**
    - Updated `UserSession` type in `hooks/useSession.ts` to include `status: RegistrationStatus;`.
    - Modified `app/(status)/pending/_components/pending-page-client.tsx` to use the custom `useSession` hook and adjusted `handleRefreshStatus` to align with the custom hook's behavior.
    - **Fixed `session.user.status` not being included in `getServerSession`**: Modified `lib/auth.ts` to include the `status` field in the JWT token and the session object during the `jwt` and `session` callbacks.
- **Implemented Project Management Feature:**
- **Fixed `PrismaClientValidationError`:** Added a check for `projectId` in `getProjectById` to ensure it's a valid string before querying the database.
- **Adjusted Project Permissions:**
    - `updateProject`: Only the project creator can edit project details. Privileged users (Admin/Lab Manager) can only change the project status.
    - `deleteProject`: Only the project creator or privileged users (Admin/Lab Manager) can delete a project.
- **Refactored ProjectForm Submission:**
    - Created `app/(dashboard)/projects/_actions.ts` to wrap `createProject` and `updateProject` server actions.
    - Modified `app/(dashboard)/projects/_components/ProjectForm.tsx` to call these new server actions, ensuring proper server-side redirection after form submission.
- **Enhanced Project Invite Functionality:**
    - Modified `app/(dashboard)/projects/[id]/members/_components/ProjectMembersClient.tsx` to display generated invite links and their corresponding QR codes in a dialog.
    - Updated `joinProjectWithToken` in `lib/actions/project.ts` to include a check for the joining user's `RegistrationStatus`. Users with `APPROVED` or `PENDING` status can proceed; others receive an error message to contact support.
    - Confirmed `app/(public)/invite/[projectId]/page.tsx` correctly handles project details display, login redirection, and error feedback from `joinProjectWithToken`.